{% extends "base.html" %}

{% block title %}Meu Evento Especial ‚Äî Compartilhe com QR Code, Fotos e V√≠deo{% endblock %}
{% block head %}
<link href="{{ url_for('static', filename='css/quill.bubble.css') }}" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/sweetalert2.min.css') }}">
<!-- Flatpickr (Date Picker) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/flatpickr.min.css') }}">
<script>
  // Fallback de CSS caso CDNs sejam bloqueados pelo navegador
  (function(){
    function cssLoadedContains(token){
      try {
        for (var i = 0; i < document.styleSheets.length; i++) {
          var href = document.styleSheets[i].href || '';
          if (href.indexOf(token) !== -1) { return true; }
        }
      } catch(e) { /* ignore */ }
      return false;
    }
    // SweetAlert2 CSS
    if (!cssLoadedContains('sweetalert2')) {
      var link1 = document.createElement('link');
      link1.rel = 'stylesheet';
      link1.href = '/static/css/sweetalert2.min.css';
      document.head.appendChild(link1);
      console.log('Fallback CSS (SweetAlert2) carregado de /static/css/sweetalert2.min.css');
    }
    // Flatpickr CSS
    if (!cssLoadedContains('flatpickr')) {
      var link2 = document.createElement('link');
      link2.rel = 'stylesheet';
      link2.href = '/static/css/flatpickr.min.css';
      document.head.appendChild(link2);
      console.log('Fallback CSS (Flatpickr) carregado de /static/css/flatpickr.min.css');
    }
  })();
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Meu Evento Especial",
  "url": "{{ canonical_url }}",
  "inLanguage": "pt-BR",
  "publisher": {
    "@type": "Organization",
    "name": "Meu Evento Especial",
    "logo": {
      "@type": "ImageObject",
      "url": "{{ url_for('static', filename='images/logo_qrcode_heart_transparent.png', _external=True) }}"
    }
  }
}
</script>
<style>
  /* Layout de se√ß√µes modernas para destacar cada feature (alinha com p√°gina do casal) */
  .page-wrap { max-width: 800px; margin: 0 auto; padding: 24px; }
  .section-title { color: var(--text-muted); font-size: 0.95rem; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 .75rem; }
  .section-card { background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 1.25rem; margin: 1.25rem 0; box-shadow: 0 6px 24px rgba(0,0,0,0.30); }
  .section-sep {
    height: 2px;
    border: none;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
    margin: 1.5rem 0;
    box-shadow: 0 0 10px rgba(255,255,255,0.12);
  }
  /* Abas (tabs) para alternar entre Pr√©via e Cria√ß√£o */
  .tab-bar { display: flex; gap: 8px; margin: 1rem 0; justify-content: center; align-items: center; }
  .tab-btn {
    padding: .45rem 1.05rem;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(0,0,0,0.35);
    color: white;
    font-weight: 600;
    font-size: 1.1rem;
    line-height: 1.1;
    cursor: pointer;
  }
  .tab-btn.active {
    background: rgba(255,255,255,0.12);
    border-color: rgba(255,255,255,0.35);
  }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  /* Aproxima o conte√∫do do header reduzindo mais o espa√ßamento superior */
  .main-content { padding-top: 0.5rem; }
  .page-wrap > .section-card:first-child { margin-top: .25rem; }
  @media (max-width: 640px) { .page-wrap { padding: 12px; } }
</style>
{% endblock %}

{% block content %}
<div class="page-wrap">
<section class="section-card text-center">
  <h1>Transforme sua Hist√≥ria em um Presente Digital Inesquec√≠vel.</h1>
  <h2 class="lead" style="color: var(--text-muted); font-weight: 500;">
    Crie uma p√°gina personalizada com suas fotos, v√≠deos e um contador de tempo exclusivo. Gere um QR Code e surpreenda quem voc√™ ama com uma homenagem que dura para sempre.
  </h2>
</section>

<!-- Abas para alternar entre pr√©via e cria√ß√£o -->
<div class="tab-bar">
  <button type="button" id="tabBtnPreview" class="tab-btn active">Pr√©via</button>
  <button type="button" id="tabBtnCreate" class="tab-btn">Crie a sua</button>
</div>

<div id="tabsPanels">
  <!-- Form Section -->
  <section id="createPanel" class="section-card tab-content">
    <h2>Personalize</h2>
    <form action="/create" method="POST" enctype="multipart/form-data" id="createForm">

      <div class="form-group">
        <label class="form-label">Nomes do Casal / Pessoas</label>
        <div class="grid-2" style="gap: 10px;">
          <input type="text" class="form-control" id="name1" name="name1" placeholder="Nome 1" required>
          <input type="text" class="form-control" id="name2" name="name2" placeholder="Nome 2 (opcional)">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Data e Hora do Evento</label>
        <div class="grid-2" style="gap: 10px;">
          <input type="date" class="form-control" id="event_date" name="event_date" required lang="pt-BR">
          <input type="time" class="form-control" id="event_time" name="event_time" required>
        </div>
        <small id="eventDateHint" style="display:block; margin-top:6px; color: var(--text-muted);">Formato: dia/m√™s/ano</small>
      </div>

      <div class="form-group">
        <label class="form-label">Tipo de Contagem</label>
        <div class="custom-radio-group">
          <div class="radio-option">
            <input type="radio" name="counter_mode" id="mode_since" value="since" checked>
            <label class="radio-label" for="mode_since">
              <i class="bi bi-clock-history"></i> Tempo desde...
            </label>
          </div>
          <div class="radio-option">
            <input type="radio" name="counter_mode" id="mode_until" value="until">
            <label class="radio-label" for="mode_until">
              <i class="bi bi-hourglass-split"></i> Contagem para...
            </label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Descri√ß√£o do Evento</label>
        <div class="d-flex gap-2" style="margin-bottom: 10px;">
          <input type="checkbox" id="customPhraseToggle">
          <label for="customPhraseToggle" style="cursor: pointer; color: var(--text-muted);">Usar frase
            personalizada</label>
        </div>

        <select name="event_description" id="eventSelect" class="form-control">
          <optgroup label="Relacionamentos amorosos üíë">
            <option value="se casaram">se casaram</option>
            <option value="se conheceram">se conheceram</option>
            <option value="come√ßaram a namorar" selected>come√ßaram a namorar</option>
            <option value="noivaram">noivaram</option>
          </optgroup>
          <optgroup label="Outros Momentos üéâ">
            <option value="se tornaram amigos">se tornaram amigos</option>
            <option value="nasceu">nasceu</option>
            <option value="realizou um sonho">realizou um sonho</option>
          </optgroup>
        </select>

        <input type="text" name="custom_event_description" id="customPhraseInput" class="form-control d-none" value="come√ßaram a namorar"
          placeholder="Ex: vamos viajar para a Disney">
        <input type="hidden" name="description_mode" id="descriptionMode" value="select">
      </div>

      <div class="form-group">
        <label class="form-label">M√≠dia</label>
        <input type="text" class="form-control" id="youtubeLink" name="youtubeLink"
          placeholder="Link do YouTube (opcional)" style="margin-bottom: 10px;">
        <label class="form-label" style="font-size: 0.9rem;">Fotos (at√© 3)</label>
        <input type="file" class="form-control" id="images" name="images" accept="image/png, image/jpeg" multiple>
        <small id="photosLimitInfo" style="display:block;margin-top:6px;color:var(--text-muted);">0/3 selecionadas</small>
        <input type="hidden" id="imageAdjustments" name="image_adjustments">
      </div>

      <div class="form-group">
        <label class="form-label">Efeitos e Fundo</label>
        <div class="grid-2" style="gap: 10px;">
          <select id="imageEffectSelector" name="effect_type" class="form-control">
            <option value="none">Sem efeito</option>
            <option value="hearts">Cora√ß√µes ‚ù§Ô∏è</option>
            <option value="stars">Estrelas ‚≠ê</option>
            <option value="confetti">Confetes üéâ</option>
          </select>
          <select id="backgroundSelector" name="background_type" class="form-control">
            <optgroup label="Gradientes Escuros üåë">
              <option value="gradient_dark8" selected>Padr√£o (Roxo/Azul)</option>
              <option value="gradient_dark_purple_deep">Roxo/Azul Profundo</option>
              <option value="gradient_dark_crimson">Preto/Vermelho Profundo</option>
              <option value="gradient_dark1">Roxo/Azul</option>
              <option value="gradient_dark5">Azul/P√∫rpura</option>
              <option value="gradient_gothic_charcoal">Preto/Cinza G√≥tico</option>
              <option value="gradient_forest">Floresta Noturna</option>
              <option value="gradient_berry">Frutas Vermelhas</option>
            </optgroup>
            <optgroup label="Gradientes Claros ‚òÄÔ∏è">
              <option value="gradient_wedding_silver">Branco Puro (Convite)</option>
            </optgroup>
            <optgroup label="Gradientes Vibrantes üåà">
              <option value="gradient_sunset">P√¥r do Sol</option>
              <option value="gradient_ocean">Oceano Profundo</option>
              <option value="gradient_love">Amor Ardente</option>
            </optgroup>
            <optgroup label="Texturas Especiais üé®">
              <option value="texture_rainbow">Arco-√≠ris Pastel</option>
              <option value="texture_marble">M√°rmore Elegante</option>
              <option value="texture_paper">Papel Antigo</option>
            </optgroup>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Tema do texto</label>
        <select id="textThemeSelector" name="text_theme" class="form-control">
          <optgroup label="Claros">
            <option value="text_theme_pink" selected>Rosa degrad√™</option>
            <option value="text_theme_gold_light">Dourado claro</option>
            <option value="text_theme_silver_light">Prata claro</option>
          </optgroup>
          <optgroup label="Escuros">
            <option value="text_theme_crimson_dark">Vermelho profundo</option>
            <option value="text_theme_ocean_dark">Azul oceano</option>
            <option value="text_theme_violet_dark">Violeta escuro</option>
          </optgroup>
          <optgroup label="Vibrantes">
            <option value="text_theme_sunset_vibrant">P√¥r do sol</option>
            <option value="text_theme_rainbow_vibrant">Arco-√≠ris</option>
          </optgroup>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Seu e-mail</label>
        <input type="email" class="form-control" id="email" name="email" placeholder="Seu e-mail" required
          style="margin-bottom: 10px;">
      </div>

      <div class="form-group">
        <label class="form-label">Sua mensagem especial (opcional)</label>
        <div id="message_editor" class="form-control" style="min-height: 120px; padding: 8px;"></div>
        <textarea id="message" name="optional_message" class="d-none"></textarea>
      </div>

      <button type="submit" class="btn btn-primary full-width" id="submitBtn">Criar Minha Homenagem</button>
    </form>
  </section>

  <!-- Preview Section (espelhando os cards da p√°gina do casal) -->
  <div id="previewPanel" class="tab-content active">
    <!-- Card: Nomes + Contador + Descri√ß√£o -->
    <div class="section-card text-center">
      <div class="section-title">Exemplo: Casal comemorando tempo de namoro</div>
      <div id="namesPreview" style="margin: 1rem 0; display:flex; justify-content:center; align-items:center; gap:.5rem;">
        <h1 id="couple_name1">Ana</h1>
        <span id="e_comercial" class="special-text" style="font-size: 2rem;">&</span>
        <h1 id="couple_name2">Jo√£o</h1>
      </div>

      <hr class="section-sep">

      <h3 id="counter_prefix_text">J√° se passaram:</h3>
      <div id="event-data" style="display:none" data-counter-mode="since"></div>
      <div class="counter-wrapper" id="meu-contador">
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Anos</span></div>
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Meses</span></div>
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Dias</span></div>
      </div>
      <h3 id="event_description_text" class="special-text" style="font-size: 1.6rem; margin-top: 1rem;">desde que come√ßamos a namorar</h3>
      <div id="finish-message" style="margin-top:.5rem;"></div>
    </div>

    <!-- Card: Fotos -->
    <div class="section-card">
      <div class="section-title">Fotos</div>
      <div id="carousel" class="carousel-container" tabindex="0"
        style="position: relative; border-radius: 16px; overflow: hidden; background: rgba(0,0,0,0.45);">
        <img src="/static/images/young-romantic-couple-sitting-on-the-beach-admiring-the-sunset-back-view_h4kowma2_thumbnail-full01.png" class="carousel-image active" data-index="0"
          alt="Casal fofo comemorando"
          style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: cover; opacity: 1; transform: translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--scale, 1)) rotate(var(--rot, 0deg)); transition: transform 0.5s ease, opacity 0.5s ease; will-change: transform, opacity;">
        <img src="/static/images/placeholder_2.png" class="carousel-image" data-index="1"
          alt="Casal fofo 2"
          style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: cover; opacity: 0; transform: translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--scale, 1)) rotate(var(--rot, 0deg)); transition: transform 0.5s ease, opacity 0.5s ease; will-change: transform, opacity;">
        <img src="/static/images/placeholder_3.png" class="carousel-image" data-index="2"
          alt="Casal fofo 3"
          style="width: 100%; height: 100%; position: absolute; top: 0; left: 0; object-fit: cover; opacity: 0; transform: translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--scale, 1)) rotate(var(--rot, 0deg)); transition: transform 0.5s ease, opacity 0.5s ease; will-change: transform, opacity;">

        <button type="button" id="editPhotoBtn" class="btn-glass-icon"
          style="position: absolute; top: 10px; right: 10px; z-index: 10; display: none;" title="Ajustar Foto" aria-label="Ajustar foto">
          <i class="bi bi-pencil-fill"></i>
        </button>

        <button type="button" id="deletePhotoBtn" class="btn-glass-icon"
          style="position: absolute; top: 10px; right: 56px; z-index: 10; display: none;" title="Excluir Foto" aria-label="Excluir foto">
          <i class="bi bi-trash-fill"></i>
        </button>

        <!-- Controles do Carrossel -->
        <div id="carouselControls" style="position:absolute; bottom:10px; left:0; width:100%; display:flex; justify-content:center; align-items:center; gap:8px; z-index:10;">
          <button type="button" id="prevPhotoBtn" class="btn-glass-icon" title="Foto anterior" aria-label="Foto anterior" style="padding:4px 8px; opacity:.7;">
            <i class="bi bi-chevron-left" style="font-size:1.1rem;"></i>
          </button>
          <div id="carouselDots" class="special-text" style="display:flex; gap:6px; align-items:center; color: inherit;"></div>
          <button type="button" id="nextPhotoBtn" class="btn-glass-icon" title="Pr√≥xima foto" aria-label="Pr√≥xima foto" style="padding:4px 8px; opacity:.7;">
            <i class="bi bi-chevron-right" style="font-size:1.1rem;"></i>
          </button>
        </div>

        <div id="presentationEffectContainer"
          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5;"></div>
      </div>
    </div>

    <!-- Card: Mensagem especial -->
    <div class="section-card message">
        <div class="section-title">Mensagem especial</div>
        <p id="optional_message_text" class="special-text" style="font-style: italic; margin-top: .5rem; white-space: pre-wrap;">üíñ Cada dia ao seu lado torna nossa hist√≥ria mais linda ‚ú®
Obrigado por caminhar comigo, por cada sorriso üòä e por todo o carinho üíûüì∏
Que nosso amor siga crescendo ‚Äî hoje, amanh√£ e sempre ‚ôæÔ∏èüí´</p>
    </div>

    <!-- Card: V√≠deo -->
    <div class="section-card">
      <div class="section-title">V√≠deo</div>
      <div id="videoPreviewContainer" style="margin-top: .5rem; border-radius: 16px; overflow: hidden; display: none;"></div>
    </div>

    <!-- Card: Compartilhar (QR exemplo) -->
    <div class="section-card">
      <div class="section-title">Compartilhar</div>
      <div style="text-align:center;">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://meueventoespecial.com.br"
          alt="QR Code Exemplo" style="width: 150px; height: 150px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); background: white; padding: 8px; display:inline-block;">
        <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px;">Exemplo de QR Code</p>
      </div>
    </div>

    <!-- Card: Validade da p√°gina (igual ao couple_page, no final) -->
    <div class="section-card" style="text-align: center;">
      <p style="margin: 0; color: var(--text-muted);">Esta p√°gina estar√° ativa at√©:</p>
      <h4 id="activeUntilValue" style="margin: .25rem 0; color: white;">--/--/---- --:--</h4>
    </div>

    <!-- Card: Pre√ßos -->
    <div class="section-card">
      <div class="section-title">Pre√ßos</div>
      <div style="display: grid; grid-template-columns: 1fr; gap: 10px;">
        <div style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: .75rem;">
          <strong>1 hora para testes</strong> ‚Äî <span class="special-text">Gr√°tis</span>
        </div>
        <div style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: .75rem;">
          <strong>30 dias</strong> ‚Äî <span class="special-text">R$ 9,90</span>
        </div>
        <div style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: .75rem;">
          <strong>90 dias</strong> ‚Äî <span class="special-text">R$ 24,90</span> <small style="color: var(--text-muted);">(economize 16%)</small>
        </div>
        <div style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,white,0.15); border-radius: 12px; padding: .75rem;">
          <strong>6 meses</strong> ‚Äî <span class="special-text">R$ 39,90</span> <small style="color: var(--text-muted);">(economize 33%)</small>
        </div>
        <div style="background: rgba(0,0,0,0.35); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: .75rem;">
          <strong>1 ano</strong> ‚Äî <span class="special-text">R$ 69,90</span> <small style="color: var(--text-muted);">(economize 41%)</small>
        </div>
      </div>
      <p style="margin-top: .75rem; color: var(--text-muted); font-size: .9rem;">Valores promocionais sujeitos a altera√ß√£o.</p>
    </div>
  </div>
</div>

<div id="photoAdjustmentModal" class="modal-overlay" style="display: none;">
  <div class="glass-card modal-content" style="max-width: 500px; width: 90%; padding: 2rem; position: relative;">
    <h3 style="margin-bottom: 1rem;">Ajustar Foto</h3>
    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1rem;">Arraste para mover e use a barra para
      dar zoom.</p>

      <div id="adjustmentContainer"
      style="width: 100%; overflow: hidden; position: relative; border-radius: 12px; background: #000; cursor: grab; margin-bottom: 1.5rem; touch-action: none;">
      <img id="adjustmentImage" src=""
        style="width: 100%; height: 100%; object-fit: contain; transform-origin: center; pointer-events: none; user-select: none;">
      <!-- Overlay de guia: regra dos ter√ßos + marca central -->
      <div id="guideOverlay" style="position: absolute; inset: 0; pointer-events: none;">
        <!-- Linhas verticais -->
        <div style="position:absolute; left:33.33%; top:0; width:1px; height:100%; background:rgba(255,255,255,0.35);"></div>
        <div style="position:absolute; left:66.66%; top:0; width:1px; height:100%; background:rgba(255,255,255,0.35);"></div>
        <!-- Linhas horizontais -->
        <div style="position:absolute; top:33.33%; left:0; height:1px; width:100%; background:rgba(255,255,255,0.35);"></div>
        <div style="position:absolute; top:66.66%; left:0; height:1px; width:100%; background:rgba(255,255,255,0.35);"></div>
        <!-- Marca central (alvo) -->
        <div style="position:absolute; top:50%; left:50%; width:12px; height:12px; margin-left:-6px; margin-top:-6px; border-radius:50%; border:2px solid rgba(255,255,255,0.7);"></div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Zoom</label>
      <input type="range" id="zoomSlider" min="0.1" max="8" step="0.1" value="1" style="width: 100%;">
    </div>

    <div class="form-group" style="margin-top: 1rem;">
      <label class="form-label">Rota√ß√£o</label>
      <div class="d-flex gap-2" style="align-items: center;">
        <button type="button" id="rotateLeft90" class="btn btn-secondary">-90¬∞</button>
        <input type="range" id="rotateSlider" min="-180" max="180" step="1" value="0" style="flex: 1;">
        <button type="button" id="rotateRight90" class="btn btn-secondary">+90¬∞</button>
      </div>
    </div>

    <div class="d-flex gap-2" style="justify-content: flex-end; margin-top: 1rem;">
      <button type="button" id="cancelAdjustmentBtn" class="btn btn-secondary">Cancelar</button>
      <button type="button" id="saveAdjustmentBtn" class="btn btn-primary">Salvar Ajuste</button>
    </div>
  </div>
</div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/sweetalert2.min.js') }}"></script>
<!-- Flatpickr JS + locale pt -->
<script src="{{ url_for('static', filename='js/flatpickr.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/flatpickr.pt.js') }}"></script>
<script>
  const quill = new Quill('#message_editor', {
    theme: 'bubble',
    modules: { toolbar: [["bold", "italic"], [{ list: "bullet" }], ["clean"]] }
  });
  const hiddenMsgField = document.getElementById('message');
  const previewMsg = document.getElementById('optional_message_text');
  function updateMessageFromEditor() {
    const html = quill.root.innerHTML.trim();
    hiddenMsgField.value = html;
    previewMsg.innerHTML = html || 'Sua mensagem especial';
  }
  quill.on('text-change', updateMessageFromEditor);
  document.getElementById('createForm').addEventListener('submit', updateMessageFromEditor);
</script>
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
{% endblock %}
