<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Lista de Itens</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <div>
          <div class="admin-title">Lista de Itens do DynamoDB</div>
          <div class="admin-sub">Gerencie páginas de casal, pagamentos e validade</div>
        </div>
        <div class="counter"><span id="counter">0</span> itens visíveis{% if total is defined and page is defined and total_pages is defined %} — Página {{ page }} de {{ total_pages }} ({{ total }} no total){% endif %}</div>
      </div>

      

      <!-- Mensagens flash -->
      {% with messages = get_flashed_messages() %} {% if messages %}
      <ul>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %} {% endwith %}

      <div class="toolbar">
        <input id="searchInput" type="text" placeholder="Buscar por email, URL ou nomes" />
        <select id="paidFilter">
          <option value="">Pago: Todos</option>
          <option value="true">Pagos</option>
          <option value="false">Pendentes</option>
        </select>
        <select id="planFilter">
          <option value="">Plano: Todos</option>
          <option value="30d">30d</option>
          <option value="90d">90d</option>
          <option value="180d">180d</option>
          <option value="365d">365d</option>
          <option value="trial">trial</option>
        </select>
        <select id="phaseFilter">
          <option value="">Fase: Todas</option>
          <option value="teste">Teste</option>
          <option value="liberado">Liberado</option>
          <option value="expirado">Expirado</option>
        </select>
        <button id="clearFilters">Limpar</button>
      </div>

      {% if total_pages is defined and total_pages > 1 %}
      <div class="actions desktop-only" style="margin: 10px 0;">
        {% if page > 1 %}
          <a class="btn" href="{{ url_for('list_dynamo_items') }}?page={{ page - 1 }}">« Anterior</a>
        {% else %}
          <span class="btn" style="opacity:0.6; cursor:default;">« Anterior</span>
        {% endif %}
        <span class="counter">Página {{ page }} de {{ total_pages }}</span>
        {% if page < total_pages %}
          <a class="btn" href="{{ url_for('list_dynamo_items') }}?page={{ page + 1 }}">Próxima »</a>
        {% else %}
          <span class="btn" style="opacity:0.6; cursor:default;">Próxima »</span>
        {% endif %}
      </div>
      {% endif %}

      <!-- Tabela desktop -->
      <div class="table-wrap">
        <table>
          <thead>
          <tr>
            <th>Email</th>
            <th>URL</th>
            <th>Nomes</th>
            <th>Evento</th>
          <th>Pago</th>
          <th>Fase</th>
          <th>Plano</th>
            <th>Preço</th>
            <th>Último Pgto</th>
            <th>Criado</th>
            <th>Validade</th>
            <th>Ações</th>
          </tr>
          </thead>
          <tbody>

          {% for item in items %}
          <tr class="item-row"
              data-email="{{ item['email'] }}"
              data-url="{{ item['page_url'] }}"
              data-name1="{{ item['name1'] }}"
              data-name2="{{ item['name2'] }}"
              data-paid="{{ item['paid'] }}"
              data-plan="{{ item.get('last_plan_code', '') or ('trial' if not item['paid'] else '') }}"
              data-expires="{{ item.get('expires_at','') }}"
              data-phase="{{ item.get('status_phase','') }}">
            <td>{{ item['email'] }}</td>
            <td>{{ item['page_url'] }}</td>
            <td>{{ item['name1'] }} &amp; {{ item['name2'] }}</td>
            <td>{{ item.get('event_br', '') }}</td>
            <td>
              {% if item['paid'] %}
                <span class="badge paid">Pago</span>
              {% else %}
                <span class="badge unpaid">Pendente</span>
              {% endif %}
            </td>
            <td>
              {% set phase = item.get('status_phase') %}
              {% if phase == 'teste' %}
                <span class="badge trial">Teste</span>
              {% elif phase == 'liberado' %}
                <span class="badge released">Liberado</span>
              {% elif phase == 'expirado' %}
                <span class="badge expired">Expirado</span>
              {% else %}
                <span class="badge">—</span>
              {% endif %}
            </td>
            <td><span class="badge plan plan-badge">
              {% if item.get('last_plan_code') %}
                {{ item.get('last_plan_code') }}
              {% elif not item['paid'] %}
                trial
              {% else %}
                
              {% endif %}
            </span></td>
            <td>
              {% set raw_price = (item.get('last_plan_price', 0) or 0) | float %}
              {% set price_fmt = '%.2f' % raw_price %}
              R$ {{ price_fmt.replace('.', ',') }}
            </td>
            <td>
              {{ item.get('last_payment_br', '') }}
            </td>
            <td>{{ item.get('created_br', '') }}</td>
            <td>{{ item.get('expires_br', '') }}</td>
            <td>
              <div class="actions">
                <a href="{{ url_for('couple_page', page_url=item['page_url']) }}" target="_blank" class="btn">Abrir</a>
                <a href="{{ url_for('edit_user', email=item['email'], page_url=item['page_url']) }}" class="btn primary">Editar</a>
                <form method="POST" action="{{ url_for('delete_item', email=item['email'], page_url=item['page_url']) }}" style="display:inline">
                  <button type="submit" class="btn danger" onclick="return confirm('Tem certeza que deseja deletar este item?')">Excluir</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
          </tbody>
        </table>
      </div>

      {% if total_pages is defined and total_pages > 1 %}
      <div class="actions mobile-only" style="margin: 10px 0;">
        {% if page > 1 %}
          <a class="btn" href="{{ url_for('list_dynamo_items') }}?page={{ page - 1 }}">« Anterior</a>
        {% else %}
          <span class="btn" style="opacity:0.6; cursor:default;">« Anterior</span>
        {% endif %}
        <span class="counter">Página {{ page }} de {{ total_pages }}</span>
        {% if page < total_pages %}
          <a class="btn" href="{{ url_for('list_dynamo_items') }}?page={{ page + 1 }}">Próxima »</a>
        {% else %}
          <span class="btn" style="opacity:0.6; cursor:default;">Próxima »</span>
        {% endif %}
      </div>
      {% endif %}

      <!-- Cards mobile -->
      <div class="cards" id="cardsContainer">
        {% for item in items %}
        <div class="card item-card"
             data-email="{{ item['email'] }}"
             data-url="{{ item['page_url'] }}"
             data-name1="{{ item['name1'] }}"
             data-name2="{{ item['name2'] }}"
             data-paid="{{ item['paid'] }}"
             data-plan="{{ item.get('last_plan_code', '') or ('trial' if not item['paid'] else '') }}"
             data-expires="{{ item.get('expires_at','') }}"
             data-phase="{{ item.get('status_phase','') }}">
          <div class="card-row">
            <div>
              <div class="card-label">Email</div>
              <div class="card-value">{{ item['email'] }}</div>
            </div>
            <div>
              <div class="card-label">URL</div>
              <div class="card-value">{{ item['page_url'] }}</div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Nomes</div>
              <div class="card-value">{{ item['name1'] }} &amp; {{ item['name2'] }}</div>
            </div>
            <div>
              <div class="card-label">Evento</div>
              <div class="card-value">{{ item.get('event_br', '') }}</div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Status</div>
              <div class="card-value">
                {% if item['paid'] %}<span class="badge paid">Pago</span>{% else %}<span class="badge unpaid">Pendente</span>{% endif %}
              </div>
            </div>
            <div>
              <div class="card-label">Fase</div>
              <div class="card-value">
                {% set phase2 = item.get('status_phase') %}
                {% if phase2 == 'teste' %}
                  <span class="badge trial">Teste</span>
                {% elif phase2 == 'liberado' %}
                  <span class="badge released">Liberado</span>
                {% elif phase2 == 'expirado' %}
                  <span class="badge expired">Expirado</span>
                {% else %}
                  <span class="badge">—</span>
                {% endif %}
              </div>
            </div>
            <div>
              <div class="card-label">Plano</div>
              <div class="card-value"><span class="badge plan plan-badge">
                {% if item.get('last_plan_code') %}
                  {{ item.get('last_plan_code') }}
                {% elif not item['paid'] %}
                  trial
                {% else %}
                  
                {% endif %}
              </span></div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Preço</div>
              {% set raw_price2 = (item.get('last_plan_price', 0) or 0) | float %}
              {% set price2 = '%.2f' % raw_price2 %}
              <div class="card-value">R$ {{ price2.replace('.', ',') }}</div>
            </div>
            <div>
              <div class="card-label">Último Pgto</div>
              <div class="card-value">{{ item.get('last_payment_br', '') }}</div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Criado</div>
              <div class="card-value">{{ item.get('created_br', '') }}</div>
            </div>
            <div>
              <div class="card-label">Validade</div>
              <div class="card-value">{{ item.get('expires_br', '') }}</div>
            </div>
          </div>
          <div class="card-actions">
            <a href="{{ url_for('couple_page', page_url=item['page_url']) }}" target="_blank" class="btn">Abrir</a>
            <a href="{{ url_for('edit_user', email=item['email'], page_url=item['page_url']) }}" class="btn primary">Editar</a>
            <form method="POST" action="{{ url_for('delete_item', email=item['email'], page_url=item['page_url']) }}" style="display:inline">
              <button type="submit" class="btn danger" onclick="return confirm('Tem certeza que deseja deletar este item?')">Excluir</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>

      {% if total_pages is defined and total_pages > 1 %}
      <div class="actions" style="margin: 10px 0;">
        {% if page > 1 %}
          <a class="btn" href="{{ url_for('list_dynamo_items') }}?page={{ page - 1 }}">« Anterior</a>
        {% else %}
          <span class="btn" style="opacity:0.6; cursor:default;">« Anterior</span>
        {% endif %}
        <span class="counter">Página {{ page }} de {{ total_pages }}</span>
        {% if page < total_pages %}
          <a class="btn" href="{{ url_for('list_dynamo_items') }}?page={{ page + 1 }}">Próxima »</a>
        {% else %}
          <span class="btn" style="opacity:0.6; cursor:default;">Próxima »</span>
        {% endif %}
      </div>
      {% endif %}

      <div style="margin-top:12px; display:flex; justify-content:flex-end;">
        <a href="{{ url_for('logout') }}" class="btn">Logout</a>
      </div>
    </div>

    <script>
      const searchInput = document.getElementById('searchInput');
      const paidFilter = document.getElementById('paidFilter');
      const planFilter = document.getElementById('planFilter');
      const phaseFilter = document.getElementById('phaseFilter');
      const clearBtn = document.getElementById('clearFilters');
      const counter = document.getElementById('counter');

      function matches(row, query, paid, plan, phase) {
        const q = (query || '').toLowerCase();
        const isPaid = String(row.dataset.paid).toLowerCase();
        const rowPlan = (row.dataset.plan || '').toLowerCase();
        const rowPhase = (row.dataset.phase || '').toLowerCase();
        const text = [row.dataset.email, row.dataset.url, row.dataset.name1, row.dataset.name2]
          .map(v => (v || '').toLowerCase()).join(' ');

        const paidOk = paid ? (isPaid === paid) : true;
        const planOk = plan ? (rowPlan === plan) : true;
        const phaseOk = phase ? (rowPhase === phase) : true;
        const textOk = q ? text.includes(q) : true;
        return paidOk && planOk && phaseOk && textOk;
      }

      function applyFilters() {
        const q = searchInput.value.trim();
        const p = paidFilter.value.trim();
        const pl = planFilter.value.trim().toLowerCase();
        const ph = phaseFilter.value.trim().toLowerCase();

        const rows = Array.from(document.querySelectorAll('tr.item-row'));
        const cards = Array.from(document.querySelectorAll('.item-card'));
        let visible = 0;

        rows.forEach(r => {
          const show = matches(r, q, p, pl, ph);
          r.style.display = show ? '' : 'none';
          if (show) visible++;
        });
        cards.forEach(c => {
          const show = matches(c, q, p, pl, ph);
          c.style.display = show ? '' : 'none';
        });
        counter.textContent = String(visible);
      }

      searchInput.addEventListener('input', applyFilters);
      paidFilter.addEventListener('change', applyFilters);
      planFilter.addEventListener('change', applyFilters);
      phaseFilter.addEventListener('change', applyFilters);
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        paidFilter.value = '';
        planFilter.value = '';
        phaseFilter.value = '';
        applyFilters();
      });

      function updatePlanStates() {
        const now = new Date();
        const rows = Array.from(document.querySelectorAll('tr.item-row'));
        const cards = Array.from(document.querySelectorAll('.item-card'));

        function setState(container) {
          const plan = (container.dataset.plan || '').toLowerCase();
          const expires = container.dataset.expires || '';
          const badge = container.querySelector('.plan-badge');
          if (!badge) return;
          // limpar estados anteriores
          badge.classList.remove('active','expired');
          const text = (badge.textContent || '').trim().toLowerCase();

          // Só colorimos quando é trial
          if (text === 'trial' || plan === 'trial') {
            let expDate = null;
            try { expDate = expires ? new Date(expires) : null; } catch (e) { expDate = null; }
            if (expDate && expDate.getTime() > now.getTime()) {
              badge.classList.add('active');
            } else {
              badge.classList.add('expired');
            }
          }
        }

        rows.forEach(setState);
        cards.forEach(setState);
      }

      // init
      applyFilters();
      updatePlanStates();
      // re-aplicar após filtros
      [searchInput, paidFilter, planFilter].forEach(el => el.addEventListener('input', updatePlanStates));
      [paidFilter, planFilter].forEach(el => el.addEventListener('change', updatePlanStates));
    </script>
  </body>
</html>
