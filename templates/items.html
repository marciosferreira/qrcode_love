<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - Lista de Itens</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}" />
  </head>
  <body>
    <div class="admin-container">
      <div class="admin-header">
        <div>
          <div class="admin-title">Lista de Itens do DynamoDB</div>
          <div class="admin-sub">Gerencie páginas de casal, pagamentos e validade</div>
        </div>
        <div class="counter"><span id="counter">0</span> itens visíveis</div>
      </div>

      <!-- Mensagens flash -->
      {% with messages = get_flashed_messages() %} {% if messages %}
      <ul>
        {% for message in messages %}
        <li>{{ message }}</li>
        {% endfor %}
      </ul>
      {% endif %} {% endwith %}

      <div class="toolbar">
        <input id="searchInput" type="text" placeholder="Buscar por email, URL ou nomes" />
        <select id="paidFilter">
          <option value="">Pago: Todos</option>
          <option value="true">Pagos</option>
          <option value="false">Pendentes</option>
        </select>
        <select id="planFilter">
          <option value="">Plano: Todos</option>
          <option value="30d">30d</option>
          <option value="90d">90d</option>
          <option value="180d">180d</option>
          <option value="365d">365d</option>
        </select>
        <button id="clearFilters">Limpar</button>
      </div>

      <!-- Tabela desktop -->
      <div class="table-wrap">
        <table>
          <tr>
            <th>Email</th>
            <th>URL</th>
            <th>Nomes</th>
            <th>Evento</th>
            <th>Pago</th>
            <th>Plano</th>
            <th>Preço</th>
            <th>Último Pgto</th>
            <th>Criado</th>
            <th>Validade</th>
            <th>Video</th>
            <th>Ações</th>
          </tr>

          {% for item in items %}
          <tr class="item-row"
              data-email="{{ item['email'] }}"
              data-url="{{ item['page_url'] }}"
              data-name1="{{ item['name1'] }}"
              data-name2="{{ item['name2'] }}"
              data-paid="{{ item['paid'] }}"
              data-plan="{{ item.get('last_plan_code', '') }}">
            <td>{{ item['email'] }}</td>
            <td>{{ item['page_url'] }}</td>
            <td>{{ item['name1'] }} &amp; {{ item['name2'] }}</td>
            <td>{{ item['event_date'] }} {{ item['event_time'] }}</td>
            <td>
              {% if item['paid'] %}
                <span class="badge paid">Pago</span>
              {% else %}
                <span class="badge unpaid">Pendente</span>
              {% endif %}
            </td>
            <td><span class="badge plan">{{ item.get('last_plan_code', '') }}</span></td>
            <td>R$ {{ '%.2f' % (item.get('last_plan_price', 0) or 0) }}</td>
            <td>{{ item.get('last_payment_at', '') }}</td>
            <td>{{ item['created_at'] }}</td>
            <td>{{ item.get('expires_at', '') }}</td>
            <td>{{ item['video_id'] }}</td>
            <td>
              <div class="actions">
                <a href="https://meueventoespecial.com.br/couple_page/{{ item['page_url'] }}" target="_blank" class="btn">Abrir</a>
                <a href="{{ url_for('edit_user', email=item['email'], page_url=item['page_url']) }}" class="btn primary">Editar</a>
                <form method="POST" action="{{ url_for('delete_item', email=item['email'], page_url=item['page_url']) }}" style="display:inline">
                  <button type="submit" class="btn danger" onclick="return confirm('Tem certeza que deseja deletar este item?')">Excluir</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </table>
      </div>

      <!-- Cards mobile -->
      <div class="cards" id="cardsContainer">
        {% for item in items %}
        <div class="card item-card"
             data-email="{{ item['email'] }}"
             data-url="{{ item['page_url'] }}"
             data-name1="{{ item['name1'] }}"
             data-name2="{{ item['name2'] }}"
             data-paid="{{ item['paid'] }}"
             data-plan="{{ item.get('last_plan_code', '') }}">
          <div class="card-row">
            <div>
              <div class="card-label">Email</div>
              <div class="card-value">{{ item['email'] }}</div>
            </div>
            <div>
              <div class="card-label">URL</div>
              <div class="card-value">{{ item['page_url'] }}</div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Nomes</div>
              <div class="card-value">{{ item['name1'] }} &amp; {{ item['name2'] }}</div>
            </div>
            <div>
              <div class="card-label">Evento</div>
              <div class="card-value">{{ item['event_date'] }} {{ item['event_time'] }}</div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Status</div>
              <div class="card-value">
                {% if item['paid'] %}<span class="badge paid">Pago</span>{% else %}<span class="badge unpaid">Pendente</span>{% endif %}
              </div>
            </div>
            <div>
              <div class="card-label">Plano</div>
              <div class="card-value"><span class="badge plan">{{ item.get('last_plan_code', '') }}</span></div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Preço</div>
              <div class="card-value">R$ {{ '%.2f' % (item.get('last_plan_price', 0) or 0) }}</div>
            </div>
            <div>
              <div class="card-label">Último Pgto</div>
              <div class="card-value">{{ item.get('last_payment_at', '') }}</div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Criado</div>
              <div class="card-value">{{ item['created_at'] }}</div>
            </div>
            <div>
              <div class="card-label">Validade</div>
              <div class="card-value">{{ item.get('expires_at', '') }}</div>
            </div>
          </div>
          <div class="card-row">
            <div>
              <div class="card-label">Video</div>
              <div class="card-value">{{ item['video_id'] }}</div>
            </div>
          </div>
          <div class="card-actions">
            <a href="https://meueventoespecial.com.br/couple_page/{{ item['page_url'] }}" target="_blank" class="btn">Abrir</a>
            <a href="{{ url_for('edit_user', email=item['email'], page_url=item['page_url']) }}" class="btn primary">Editar</a>
            <form method="POST" action="{{ url_for('delete_item', email=item['email'], page_url=item['page_url']) }}" style="display:inline">
              <button type="submit" class="btn danger" onclick="return confirm('Tem certeza que deseja deletar este item?')">Excluir</button>
            </form>
          </div>
        </div>
        {% endfor %}
      </div>

      <div style="margin-top:12px; display:flex; justify-content:flex-end;">
        <a href="{{ url_for('logout') }}" class="btn">Logout</a>
      </div>
    </div>

    <script>
      const searchInput = document.getElementById('searchInput');
      const paidFilter = document.getElementById('paidFilter');
      const planFilter = document.getElementById('planFilter');
      const clearBtn = document.getElementById('clearFilters');
      const counter = document.getElementById('counter');

      function matches(row, query, paid, plan) {
        const q = (query || '').toLowerCase();
        const isPaid = String(row.dataset.paid).toLowerCase();
        const rowPlan = (row.dataset.plan || '').toLowerCase();
        const text = [row.dataset.email, row.dataset.url, row.dataset.name1, row.dataset.name2]
          .map(v => (v || '').toLowerCase()).join(' ');

        const paidOk = paid ? (isPaid === paid) : true;
        const planOk = plan ? (rowPlan === plan) : true;
        const textOk = q ? text.includes(q) : true;
        return paidOk && planOk && textOk;
      }

      function applyFilters() {
        const q = searchInput.value.trim();
        const p = paidFilter.value.trim();
        const pl = planFilter.value.trim().toLowerCase();

        const rows = Array.from(document.querySelectorAll('tr.item-row'));
        const cards = Array.from(document.querySelectorAll('.item-card'));
        let visible = 0;

        rows.forEach(r => {
          const show = matches(r, q, p, pl);
          r.style.display = show ? '' : 'none';
          if (show) visible++;
        });
        cards.forEach(c => {
          const show = matches(c, q, p, pl);
          c.style.display = show ? '' : 'none';
        });
        counter.textContent = String(visible);
      }

      searchInput.addEventListener('input', applyFilters);
      paidFilter.addEventListener('change', applyFilters);
      planFilter.addEventListener('change', applyFilters);
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        paidFilter.value = '';
        planFilter.value = '';
        applyFilters();
      });

      // init
      applyFilters();
    </script>
  </body>
</html>
