{% extends "base.html" %}

{% block head %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "{{ page_title }}",
  "url": "{{ canonical_url }}",
  "inLanguage": "pt-BR",
  "description": "{{ meta_description }}",
  "primaryImageOfPage": {
    "@type": "ImageObject",
    "url": "{{ og_image_url }}"
  }
}
</script>
<style>
  /* Oculta a barra superior e o rodap√© para p√°gina pessoal paga */
  .glass-header, .glass-footer { display: none !important; }
  .app-container { padding-top: 0; }
  /* Layout de se√ß√µes modernas para destacar cada feature */
  .page-wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
  .section-title { color: var(--text-muted); font-size: 0.95rem; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 .75rem; }
  .section-card { background: rgba(0,0,0,0.45); border: 1px solid rgba(255,255,255,0.12); border-radius: 16px; padding: 1.25rem; margin: 1.25rem 0; box-shadow: 0 6px 24px rgba(0,0,0,0.30); }
  .section-card.message { text-align: center; }
  .section-sep {
    height: 2px;
    border: none;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.22), transparent);
    margin: 1.5rem 0;
    box-shadow: 0 0 10px rgba(255,255,255,0.12);
  }
  .names-display h1 { margin: 0 .5rem; }
  .counter-section .counter-wrapper { margin-top: .75rem; }
  .actions-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
  .actions-row .qr { display: flex; flex-direction: column; align-items: center; }
  .actions-row .cta { flex: 1; min-width: 260px; }
  .cta .btn { width: 100%; }
  @media (max-width: 640px) { .page-wrap { padding: 12px; } }
</style>
{% endblock %}

{% block title %}{{ couple.name1 }} & {{ couple.name2 if couple.name2 else '' }}{% endblock %}

{% block content %}
<div class="page-wrap">
  <div class="section-card text-center">
    <div class="names-display" style="margin-bottom: 1rem; display:flex; justify-content:center; align-items:center;">
      <h1>{{ couple.name1 }}</h1>
      {% if couple.name2 %}
      <span class="special-text {{ couple.text_theme or 'text_theme_pink' }}" style="font-size: 2rem;">&</span>
      <h1>{{ couple.name2 }}</h1>
      {% endif %}
    </div>

    <hr class="section-sep">

    <div class="counter-section">
      <div id="event-data" data-event-date="{{ couple.event_date }}" data-event-time="{{ couple.event_time }}"
        data-counter-mode="{{ display_counter_mode }}" style="display: none;"></div>

      {% if display_counter_mode == 'until' %}
      <h3 style="margin-top: .5rem;">Faltam:</h3>
      {% else %}
      <h3 style="margin-top: .5rem;">J√° se passaram:</h3>
      {% endif %}

      <div class="counter-wrapper" id="meu-contador" style="margin-bottom: .75rem;">
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Anos</span></div>
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Meses</span></div>
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Dias</span></div>
      </div>

      <div id="finish-message" style="margin-top:.5rem;"></div>

      <h3 class="special-text {{ couple.text_theme or 'text_theme_pink' }}" style="font-size: 1.8rem; margin-top: .75rem;">
        {% if display_counter_mode == 'until' %}
        para {{ couple.event_description }}
        {% else %}
        desde que {{ couple.event_description }}
        {% endif %}
      </h3>
      </div>
    </div>

  {% if image_exists %}
  <div class="section-card">
    <div class="section-title">Fotos</div>
    <div id="carousel" class="carousel-container" tabindex="0"
      style="position: relative; border-radius: 16px; overflow: hidden; background: rgba(0,0,0,0.2);">
      {% for image in images %}
      {% if loop.first %}
      <img src="{{ s3_base_url }}/{{ image }}"
        class="carousel-image active" data-index="{{ loop.index0 }}"
        style="width: 100%; height: 100%; position:absolute; top: 0; left: 0; opacity: 1; transform: translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--scale, 1)) rotate(var(--rot, 0deg)); transition: transform 0.6s ease, opacity 0.6s ease; will-change: transform, opacity;">
      {% else %}
      <img src="{{ s3_base_url }}/{{ image }}"
        class="carousel-image" data-index="{{ loop.index0 }}"
        style="width: 100%; height: 100%; position:absolute; top: 0; left: 0; opacity: 0; transform: translate(var(--tx, 0px), var(--ty, 0px)) scale(var(--scale, 1)) rotate(var(--rot, 0deg)); transition: transform 0.6s ease, opacity 0.6s ease; will-change: transform, opacity;">
      {% endif %}
      {% endfor %}

      <!-- Controles do Carrossel -->
      <div id="carouselControls" style="position:absolute; bottom:10px; left:0; width:100%; display:flex; justify-content:center; align-items:center; gap:8px; z-index:10;">
        <button type="button" id="prevPhotoBtn" class="btn-glass-icon" title="Foto anterior" aria-label="Foto anterior" style="padding:4px 8px; opacity:.7;">
          <i class="bi bi-chevron-left" style="font-size:1.1rem;"></i>
        </button>
        <div id="carouselDots" class="special-text {{ couple.text_theme or 'text_theme_pink' }}" style="display:flex; gap:6px; align-items:center; color: inherit;"></div>
        <button type="button" id="nextPhotoBtn" class="btn-glass-icon" title="Pr√≥xima foto" aria-label="Pr√≥xima foto" style="padding:4px 8px; opacity:.7;">
          <i class="bi bi-chevron-right" style="font-size:1.1rem;"></i>
        </button>
      </div>

      <div id="presentationEffectContainer"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
    </div>
  </div>
  {% endif %}

  {% set msg_clean = (couple.optional_message or '') | striptags | trim %}
  {% if msg_clean %}
    <div class="section-card message">
      <div class="section-title">Mensagem especial</div>
      <div id="optional_message_text" data-theme="{{ couple.text_theme or 'text_theme_pink' }}" class="special-text" style="font-style: italic; font-size: 1.2rem; white-space: pre-wrap;">{{ couple.optional_message | safe }}</div>
  </div>
  {% endif %}

  {% if couple.video_id %}
  <div class="section-card">
    <div class="section-title">V√≠deo</div>
    <div id="videoContainer" style="margin-top: .5rem;"></div>
  </div>
  {% endif %}

  <div class="section-card">
    <div class="section-title">Compartilhar</div>
    <div class="qr" style="text-align:center;">
      <img src="{{ qr_code_path }}" alt="QR Code"
        style="width: 150px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
      <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px;">Compartilhe esta p√°gina</p>
    </div>
  </div>

  {% if valid_until_str %}
  <div class="section-card" style="text-align: center;">
    <p style="margin: 0; color: var(--text-muted);">Esta p√°gina estar√° ativa at√©:</p>
    <h4 style="margin: .25rem 0; color: white;">{{ valid_until_str }}</h4>
  </div>
  {% endif %}

  {% if show_payment_link and not couple.paid %}
  <div class="section-card">
    <div class="section-title">Extens√£o de validade</div>
    <div style="text-align: left;">
      <h4 style="margin:0; color:white;">Teste esta p√°gina √† vontade por 1 hora.</h4>
      <p style="margin:.25rem 0 .75rem; color:#bbb; font-size:.95rem;">Deseja manter esta p√°gina ativa e esconder este aviso?</p>
      <div>
        <button id="openPlanModalBtn" type="button" class="btn btn-primary" style="border-radius: 12px; padding: .6rem 1rem; font-weight: 600;">
          Estender a partir de R$ 9,90
        </button>
        <span style="margin-left: .75rem; color:#aaa; font-size:.9rem;">Pagamento seguro via Asaas (PIX)</span>
      </div>
    </div>
  </div>

  <!-- Modal de sele√ß√£o de planos -->
  <div id="planModal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 9999; display: none; align-items: center; justify-content: center;">
    <div style="background: #1f1f1f; border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 24px; max-width: 560px; width: 92%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
      <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 8px;">
        <h3 style="color: white; margin: 0;">Escolha um plano</h3>
        <button id="closePlanModalBtn" type="button" style="background: transparent; border: none; color: #ccc; font-size: 1.2rem; cursor: pointer;">‚úï</button>
      </div>
      <p style="color: #bbb; margin: 0 0 16px;">Selecione a validade desejada e prossiga com o pagamento:</p>
      <form action="{{ url_for('pay', id=couple.page_url) }}" method="post" style="display:flex; flex-direction:column; gap:.5rem;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; text-align:left;">
          <label style="background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:.6rem; border-radius:10px;">
            <input type="radio" name="plan" value="30d" checked> 30 dias ‚Äî R$ 9,90
          </label>
          <label style="background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:.6rem; border-radius:10px;">
            <input type="radio" name="plan" value="90d"> 90 dias ‚Äî R$ 24,90 (economize 16%)
          </label>
          <label style="background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:.6rem; border-radius:10px;">
            <input type="radio" name="plan" value="180d"> 6 meses ‚Äî R$ 39,90 (economize 33%)
          </label>
          <label style="background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:.6rem; border-radius:10px;">
            <input type="radio" name="plan" value="365d"> 1 ano ‚Äî R$ 69,90 (economize 41%)
          </label>
        </div>
        <button type="submit" class="btn btn-primary" style="border-radius: 12px; padding: .6rem 1rem; font-weight: 600; margin-top:.5rem;">Avan√ßar para o pagamento via Pix</button>
      </form>
    </div>
  </div>

  <script>
    (function(){
      var openBtn = document.getElementById('openPlanModalBtn');
      var modal = document.getElementById('planModal');
      var closeBtn = document.getElementById('closePlanModalBtn');
      if(openBtn && modal){
        openBtn.addEventListener('click', function(){ modal.style.display = 'flex'; });
      }
      if(closeBtn && modal){
        closeBtn.addEventListener('click', function(){ modal.style.display = 'none'; });
      }
      // Fecha ao clicar fora do conte√∫do
      if(modal){
        modal.addEventListener('click', function(e){
          if(e.target === modal){ modal.style.display = 'none'; }
        });
      }
    })();
  </script>
  {% endif %}

  {% if is_expired and not is_admin_view %}
  <!-- Modal bloqueante de expira√ß√£o -->
  <div id="expiredOverlay" style="position: fixed; inset: 0; background: rgba(0,0,0,0.75); z-index: 9999; display: flex; align-items: center; justify-content: center;">
    <div style="background: #1f1f1f; border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 24px; max-width: 560px; width: 92%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
      <h3 style="color: white; margin: 0 0 8px;">P√°gina expirada</h3>
      <p style="color: #bbb; margin: 0 0 16px;">Para continuar, renove a validade escolhendo um plano:</p>
      <form action="{{ url_for('pay', id=couple.page_url) }}" method="post" style="display:flex; flex-direction:column; gap:.5rem; margin-top: 8px;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:.5rem; text-align:left;">
          <label style="background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:.6rem; border-radius:10px;">
            <input type="radio" name="plan" value="30d" checked> 30 dias ‚Äî R$ 9,90
          </label>
          <label style="background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:.6rem; border-radius:10px;">
            <input type="radio" name="plan" value="90d"> 90 dias ‚Äî R$ 24,90 (economize 16%)
          </label>
          <label style="background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:.6rem; border-radius:10px;">
            <input type="radio" name="plan" value="180d"> 6 meses ‚Äî R$ 39,90 (economize 33%)
          </label>
          <label style="background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15); padding:.6rem; border-radius:10px;">
            <input type="radio" name="plan" value="365d"> 1 ano ‚Äî R$ 69,90 (economize 41%)
          </label>
        </div>
        <button type="submit" class="btn btn-primary" style="border-radius: 12px; padding: .6rem 1rem; font-weight: 600;">Pagar e renovar</button>
        <p style="color:#888; font-size:.9rem; margin-top:10px;">Pagamento seguro via Asaas (PIX)</p>
      </form>
    </div>
  </div>
  <script>
    // Bloqueia rolagem enquanto expirada
    document.documentElement.style.overflow = 'hidden';
    document.body.style.overflow = 'hidden';
  </script>
  {% endif %}

  <input type="hidden" id="imageEffectSelector" value="{{ couple.effect_type }}">
  <input type="hidden" id="imageAdjustmentsData" value='{{ image_adjustments|tojson }}'>
  <input type="hidden" id="videoId" value="{{ couple.video_id }}">
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
  $(document).ready(function () {
    // Photo adjustments
    try {
      const adj = JSON.parse($('#imageAdjustmentsData').val() || '{}');
      $('.carousel-image').each(function (i) {
        const a = adj[i.toString()];
        if (a) $(this).css({
          '--tx': `${a.x}px`,
          '--ty': `${a.y}px`,
          '--scale': a.scale,
          '--rot': `${(a.rotate || 0)}deg`,
          'transform-origin': 'center'
        });
      });
    } catch (e) { }

    // Video cover
    const vid = $('#videoId').val();
    if (vid) {
      $('#videoContainer').append(`
      <div class="video-cover" style="position:relative;padding-bottom:56.25%;background:linear-gradient(135deg,#1a1a1a,#2c2c2c);cursor:pointer;border-radius:16px;margin-top:1rem;">
        <div style="position:absolute;top:43%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:2;display:flex;flex-direction:column;align-items:center;gap:.25rem;">
          <div style="font-size:3rem;line-height:1;">üéÅ</div>
          <h4 style="color:white;margin:0;line-height:1.1;">V√≠deo Surpresa</h4>
          <p style="color:#aaa;font-size:0.95rem;margin:0;line-height:1.1;">Clique para assistir (com som) üîä</p>
        </div>
        <div class="hover-layer" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.05);opacity:0;transition:opacity .3s;border-radius:16px;z-index:1;"></div>
      </div>
    `);
      $('.video-cover').hover(
        function () { $(this).find('.hover-layer').css('opacity', 1); },
        function () { $(this).find('.hover-layer').css('opacity', 0); }
      ).click(function () {
        $(this).replaceWith(`<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:16px;"><iframe src="https://www.youtube.com/embed/${vid}?autoplay=1" frameborder="0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;border:none;"></iframe></div>`);
      });
    }
  });
</script>
<script>
  // Isola emojis e aplica tema APENAS em texto n√£o-emoji (como na pr√©via)
  (function(){
    function isEmojiChar(ch){
      const cp = ch.codePointAt(0);
      return (
        (cp >= 0x1F300 && cp <= 0x1FAFF) ||
        (cp >= 0x2600 && cp <= 0x27BF) ||
        cp === 0x2764 ||
        cp === 0x1F970 ||
        cp === 0x1F48D ||
        cp === 0x1F4F8 ||
        cp === 0x1F3B5 ||
        cp === 0x2600
      );
    }
    function wrapTextNode(node, theme){
      const text = node.nodeValue;
      let frag = document.createDocumentFragment();
      let buffer = "";
      for (const ch of text){
        if (isEmojiChar(ch)){
          if (buffer){
            const spanTxt = document.createElement('span');
            spanTxt.className = `themed-text special-text ${theme}`;
            spanTxt.textContent = buffer;
            frag.appendChild(spanTxt);
            buffer = "";
          }
          const span = document.createElement('span');
          span.className = 'emoji';
          span.textContent = ch;
          frag.appendChild(span);
        } else {
          buffer += ch;
        }
      }
      if (buffer){
        const spanTxt = document.createElement('span');
        spanTxt.className = `themed-text special-text ${theme}`;
        spanTxt.textContent = buffer;
        frag.appendChild(spanTxt);
      }
      node.parentNode.replaceChild(frag, node);
    }
    function traverseAndWrap(root){
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
      const toProcess = [];
      let n;
      while ((n = walker.nextNode())){
        // Ignora n√≥s vazios ou s√≥ espa√ßo
        if (!n.nodeValue || !n.nodeValue.trim()) continue;
        // Processa todos os n√≥s de texto; a fun√ß√£o wrap s√≥ criar√° spans para emojis
        toProcess.push(n);
      }
      const theme = root.getAttribute('data-theme') || 'text_theme_pink';
      toProcess.forEach(function(node){ wrapTextNode(node, theme); });
    }
    const container = document.getElementById('optional_message_text');
    if (container && !container.querySelector('.emoji') && !container.querySelector('.themed-text')){
      traverseAndWrap(container);
    }
  })();
</script>
{% endblock %}
