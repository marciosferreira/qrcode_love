{% extends "base.html" %}

{% block head %}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "{{ page_title }}",
  "url": "{{ canonical_url }}",
  "inLanguage": "pt-BR",
  "description": "{{ meta_description }}",
  "primaryImageOfPage": {
    "@type": "ImageObject",
    "url": "{{ og_image_url }}"
  }
}
</script>
<style>
  /* Oculta a barra superior e o rodap√© para p√°gina pessoal paga */
  .glass-header, .glass-footer { display: none !important; }
  .app-container { padding-top: 0; }
  /* Layout de se√ß√µes modernas para destacar cada feature */
  .page-wrap { max-width: 960px; margin: 0 auto; padding: 24px; }
  .section-title { color: var(--text-muted); font-size: 0.95rem; text-transform: uppercase; letter-spacing: 2px; margin: 0 0 .75rem; }
  .section-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 1.25rem; margin: 1.25rem 0; }
  .section-sep { height: 1px; border: none; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent); margin: 1.5rem 0; }
  .names-display h1 { margin: 0 .5rem; }
  .counter-section .counter-wrapper { margin-top: .75rem; }
  .actions-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
  .actions-row .qr { display: flex; flex-direction: column; align-items: center; }
  .actions-row .cta { flex: 1; min-width: 260px; }
  .cta .btn { width: 100%; }
  @media (max-width: 640px) { .page-wrap { padding: 12px; } }
</style>
{% endblock %}

{% block title %}{{ couple.name1 }} & {{ couple.name2 if couple.name2 else '' }}{% endblock %}

{% block content %}
<div class="page-wrap">
  <div class="section-card text-center">
    <h2 class="special-text">Homenagem a</h2>
    <div class="names-display" style="margin-bottom: 1rem; display:flex; justify-content:center; align-items:center;">
      <h1>{{ couple.name1 }}</h1>
      {% if couple.name2 %}
      <span class="special-text" style="font-size: 2rem;">&</span>
      <h1>{{ couple.name2 }}</h1>
      {% endif %}
    </div>

    <hr class="section-sep">

    <div class="counter-section">
      <div id="event-data" data-event-date="{{ couple.event_date }}" data-event-time="{{ couple.event_time }}"
        data-counter-mode="{{ display_counter_mode }}" style="display: none;"></div>

      {% if display_counter_mode == 'until' %}
      <h3>Faltam:</h3>
      {% else %}
      <h3>J√° se passaram:</h3>
      {% endif %}

      <div class="counter-wrapper" id="meu-contador">
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Anos</span></div>
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Meses</span></div>
        <div class="time-box"><span class="time-value">0</span><span class="time-label">Dias</span></div>
      </div>

      <h3 class="special-text" style="font-size: 1.8rem; margin-top: 1rem;">
        {% if display_counter_mode == 'until' %}
        para {{ couple.event_description }}
        {% else %}
        desde que {{ couple.event_description }}
        {% endif %}
      </h3>
    </div>
  </div>

  {% if image_exists %}
  <div class="section-card">
    <div class="section-title">Fotos</div>
    <div id="carousel"
      style="position: relative; height: 500px; border-radius: 16px; overflow: hidden; background: rgba(0,0,0,0.2);">
      {% for image in images %}
      {% if loop.first %}
      <img src="https://qrcodelove-pictures.s3.amazonaws.com/{{ image }}"
        class="carousel-image active" data-index="{{ loop.index0 }}"
        style="width: 100%; height: 100%; object-fit: contain; position:absolute; top: 0; left: 0; opacity: 1; transition: opacity 1s;">
      {% else %}
      <img src="https://qrcodelove-pictures.s3.amazonaws.com/{{ image }}"
        class="carousel-image" data-index="{{ loop.index0 }}"
        style="width: 100%; height: 100%; object-fit: contain; position:absolute; top: 0; left: 0; opacity: 0; transition: opacity 1s;">
      {% endif %}
      {% endfor %}
      <div id="presentationEffectContainer"
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></div>
    </div>
  </div>
  {% endif %}

  {% if couple.optional_message %}
  <div class="section-card">
    <div class="section-title">Mensagem especial</div>
    <p style="font-style: italic; font-size: 1.2rem; white-space: pre-wrap;">{{ couple.optional_message | safe }}</p>
  </div>
  {% endif %}

  {% if couple.video_id %}
  <div class="section-card">
    <div class="section-title">V√≠deo</div>
    <div id="videoContainer" style="margin-top: .5rem;"></div>
  </div>
  {% endif %}

  <div class="section-card">
    <div class="section-title">Compartilhar</div>
    <div class="qr" style="text-align:center;">
      <img src="{{ qr_code_path }}" alt="QR Code"
        style="width: 150px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
      <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 10px;">Compartilhe esta p√°gina</p>
    </div>
  </div>

  {% if show_payment_link %}
  <div class="section-card">
    <div class="section-title">Extens√£o de validade</div>
    {% if not couple.paid %}
    <div style="text-align: left;">
            <h4 style="margin:0; color:white;">Teste esta p√°gina a vontade por 1 hora.</h4>

      <h4 style="margin:0; color:white;">Deseja manter esta p√°gina ativa e esconder este aviso?</h4>
      <p style="margin:.25rem 0 .75rem; color:#bbb; font-size:.95rem;">Estenda por 30 dias com um pagamento via PIX.</p>
      <form action="{{ url_for('pay', id=couple.page_url) }}" method="post">
        <button type="submit" class="btn btn-primary" style="border-radius: 12px; padding: .6rem 1rem; font-weight: 600;">
          Estender por 30 dias ‚Äî R$ 5,00
        </button>
        <span style="margin-left: .75rem; color:#aaa; font-size:.9rem;">Pagamento seguro via Asaas (PIX)</span>
      </form>
    </div>
    {% else %}
    <div class="glass-card" style="padding: .75rem; background: rgba(0,255,0,0.06); border: 1px solid rgba(0,255,0,0.15);">
      <p style="margin:0; color:#b6fcb6;">Pagamento confirmado! Sua p√°gina est√° ativa por 30 dias üéâ</p>
    </div>
    {% endif %}
  </div>
  {% endif %}

  <input type="hidden" id="imageEffectSelector" value="{{ couple.effect_type }}">
  <input type="hidden" id="imageAdjustmentsData" value='{{ image_adjustments|tojson }}'>
  <input type="hidden" id="videoId" value="{{ couple.video_id }}">
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/script.js') }}"></script>
<script>
  $(document).ready(function () {
    // Photo adjustments
    try {
      const adj = JSON.parse($('#imageAdjustmentsData').val() || '{}');
      $('.carousel-image').each(function (i) {
        const a = adj[i.toString()];
        if (a) $(this).css({ 'transform': `translate(${a.x}px, ${a.y}px) scale(${a.scale}) rotate(${(a.rotate || 0)}deg)`, 'transform-origin': 'center' });
      });
    } catch (e) { }

    // Video cover
    const vid = $('#videoId').val();
    if (vid) {
      $('#videoContainer').append(`
      <div class="video-cover" style="position:relative;padding-bottom:56.25%;background:linear-gradient(135deg,#1a1a1a,#2c2c2c);cursor:pointer;border-radius:16px;margin-top:1rem;">
        <div style="position:absolute;top:43%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:2;display:flex;flex-direction:column;align-items:center;gap:.25rem;">
          <div style="font-size:3rem;line-height:1;">üéÅ</div>
          <h4 style="color:white;margin:0;line-height:1.1;">V√≠deo Surpresa</h4>
          <p style="color:#aaa;font-size:0.95rem;margin:0;line-height:1.1;">Clique para assistir (com som) üîä</p>
        </div>
        <div class="hover-layer" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.05);opacity:0;transition:opacity .3s;border-radius:16px;z-index:1;"></div>
      </div>
    `);
      $('.video-cover').hover(
        function () { $(this).find('.hover-layer').css('opacity', 1); },
        function () { $(this).find('.hover-layer').css('opacity', 0); }
      ).click(function () {
        $(this).replaceWith(`<div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:16px;"><iframe src="https://www.youtube.com/embed/${vid}?autoplay=1" frameborder="0" allow="accelerometer;autoplay;clipboard-write;encrypted-media;gyroscope;picture-in-picture" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%;border:none;"></iframe></div>`);
      });
    }
  });
</script>
{% endblock %}
