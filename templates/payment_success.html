{% extends "base.html" %}
{% block content %}
<div class="glass-card">
  <h2>Pagamento confirmado</h2>
  <p style="margin-bottom:1rem; color: var(--text-muted);">
    Obrigado! Seu pagamento foi processado.
  </p>
  <p style="margin-bottom:1rem;">Você pode continuar pelo botão abaixo.</p>
  <a href="{{ redirect_url }}" class="btn btn-primary">Ir agora</a>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    var params = new URLSearchParams(location.search);
    var debug = params.has('debug') || params.has('_dbg') || params.has('debug_mode');
    // Valor: começa pelo conv_value do servidor; se 0, tenta ?v= da URL
    var v = Number("{{ conv_value|default(0, true) }}");
    if (!v || v <= 0) {
      var vq = params.get('v');
      if (vq) { v = Number((vq || '').replace(',', '.')); }
    }

    var txnId = '{{ transaction_id|default(page_url, true) }}';
    var payload = {
      value: (isFinite(v) && v > 0) ? v : 0,
      currency: 'BRL',
      transaction_id: txnId,
      items: [{
        item_id: '{{ plan_code|default("unknown", true) }}',
        item_name: 'Plano {{ plan_code|default("unknown", true) }}',
        price: (isFinite(v) && v > 0) ? v : 0,
        quantity: 1
      }],
      debug_mode: debug
    };

    // Deduplicação por sessão
    var ss = window.sessionStorage;
    var gaKey = 'ga4_purchase_' + txnId;
    var adsKey = 'ads_conv_' + txnId;
    var gaAlready = !!(ss && ss.getItem(gaKey) === '1');
    var adsAlready = !!(ss && ss.getItem(adsKey) === '1');

    function sendGa4Purchase(){
      if (typeof gtag !== 'function') return false;
      if (!gaAlready) {
        try {
          gtag('event', 'purchase', Object.assign({}, payload, {
            event_callback: function(){ console.log('GA4 purchase callback confirmado'); }
          }));
          try { if (ss) ss.setItem(gaKey, '1'); } catch(e) {}
          console.log('GA4 purchase enviado:', payload);
        } catch(e){ console.warn('Falha ao enviar GA4 purchase:', e); }
      } else {
        console.log('GA4 purchase já enviado anteriormente para txn_id:', txnId);
      }
      return true;
    }

    // Snippet de conversão do Google Ads (fixo), com dados dinâmicos
    var SEND_TO = 'AW-1051093117/kUJBCJnc8scbEP3QmfUD';
    function sendAdsConversion(){
      if (typeof gtag !== 'function') return false;
      if (!adsAlready) {
        try {
          gtag('event', 'conversion', {
            send_to: SEND_TO,
            value: payload.value,
            currency: payload.currency,
            transaction_id: payload.transaction_id
          });
          try { if (ss) ss.setItem(adsKey, '1'); } catch(e) {}
          console.log('Google Ads conversion enviado:', SEND_TO, payload.value);
        } catch(e){ console.warn('Falha ao enviar Ads conversion:', e); }
      } else {
        console.log('Google Ads conversion já enviado anteriormente para txn_id:', txnId);
      }
      return true;
    }

    // Disparo com pequenas tentativas para garantir gtag pronto
    var tries = 0;
    function trySend(){
      tries++;
      var ok1 = sendGa4Purchase();
      var ok2 = sendAdsConversion();
      if (!(ok1 && ok2) && tries < 6) setTimeout(trySend, 400);
    }

    window.addEventListener('load', function(){
      setTimeout(trySend, 300);
      setTimeout(function(){ trySend(); }, 1200);
    });
  })();
</script>
{% endblock %}
