{% extends "base.html" %}
{% block content %}
<div class="glass-card">
  <h2>Pagamento confirmado</h2>
  <p style="margin-bottom:1rem; color: var(--text-muted);">
    Obrigado! Seu pagamento foi processado.
  </p>
  <a href="{{ redirect_url }}" class="btn btn-primary">Ver página</a>
</div>
{% endblock %}

{% block scripts %}
  <script id="purchase-data" type="application/json">
    {{ {'event':'purchase','value': conv_value|default(0), 'currency':'BRL'}|tojson }}
  </script>
  <script>
    (function(){
      var el = document.getElementById('purchase-data');
      var payload = { event: 'purchase', value: 0, currency: 'BRL' };
      try {
        var parsed = JSON.parse((el && el.textContent) || '{}');
        if (parsed && typeof parsed === 'object') {
          payload = parsed;
          if (typeof payload.value === 'string') {
            payload.value = parseFloat(payload.value) || 0;
          }
        }
      } catch (e) {}
      window.dataLayer = window.dataLayer || [];
      var val = Number(payload.value) || 0;
      if (val <= 0) {
        var params = new URLSearchParams(location.search || '');
        var qv = params.get('v');
        var qn = Number(qv || 0);
        if (!isNaN(qn) && qn > 0) { val = qn; }
      }
      if (val > 0) {
        payload.value = val;
        // Opcional: se tiver transaction_id disponível no template, inclua-o no JSON
        window.dataLayer.push(payload);
      }
    })();
  </script>
{% if aw_id and aw_label %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ aw_id }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', '{{ aw_id }}');
    // Dispara a conversão do Google Ads com segurança
    setTimeout(function() {
      var v = Number("{{ conv_value|default(0) }}") || 0;
      if (v > 0) {
        gtag('event', 'conversion', {
          send_to: '{{ aw_id }}/{{ aw_label }}',
          value: v,
          currency: 'BRL'
        });
      }
    }, 0);
  </script>
{% endif %}
{% endblock %}
