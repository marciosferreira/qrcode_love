{% extends "base.html" %}
{% block content %}
<div class="glass-card">
  <h2>Pagamento confirmado</h2>
  <p style="margin-bottom:1rem; color: var(--text-muted);">
    Obrigado! Seu pagamento foi processado.
  </p>
  <p style="margin-bottom:1rem;">Voc√™ pode continuar pelo bot√£o abaixo.</p>
  <a href="{{ redirect_url }}" class="btn btn-primary">Ir agora</a>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    // 
    
    // 1. Tratamento robusto de valores (Onde a maioria dos erros acontece)
    // Converte explicitamente para String antes de trocar v√≠rgula por ponto
    var rawServerValue = String("{{ conv_value|default(0, true) }}"); 
    var urlParams = new URLSearchParams(location.search);
    var debug = urlParams.has('debug') || urlParams.has('_dbg') || urlParams.has('debug_mode');
    
    // Tenta pegar valor do servidor, sen√£o tenta da URL (?v=)
    var v = parseFloat(rawServerValue.replace(',', '.'));
    
    if (isNaN(v) || v <= 0) {
      var vq = urlParams.get('v');
      if (vq) {
        v = parseFloat((vq || '').replace(',', '.'));
      }
    }
    
    // Valor final sanitizado
    var finalValue = (isFinite(v) && v > 0) ? v : 0;

    // 2. Defini√ß√£o do Payload
    var payload = {
      value: finalValue,
      currency: 'BRL',
      transaction_id: '{{ transaction_id|default(page_url, true) }}',
      // GA4 exige que 'items' tenha par√¢metros espec√≠ficos
      items: [{
        item_id: '{{ plan_code|default("unknown", true) }}',
        item_name: 'Plano {{ plan_code|default("unknown", true) }}',
        price: finalValue,
        quantity: 1
      }],
      debug_mode: debug // Isso for√ßa o evento a aparecer no DebugView do Analytics
    };

    // Controle de deduplica√ß√£o ‚Äî altern√¢ncia f√°cil
    // Mude este flag para habilitar/desabilitar rapidamente:
    // true  -> desativa dedupe (sempre envia)
    // false -> ativa dedupe (evita reenvio na mesma sess√£o)
    // null  -> controla via URL (?no_dedupe=1 ou ?dedupe=off)
    var FORCE_DEDUPE_OFF = true;

    // Determina o estado final de dedupe
    var noDedupe = (typeof FORCE_DEDUPE_OFF === 'boolean')
      ? FORCE_DEDUPE_OFF
      : (urlParams.has('no_dedupe') || (urlParams.get('dedupe') === 'off'));
    console.log('Dedupe est√°', noDedupe ? 'desativada' : 'ativada');
    if (noDedupe) {
      // Opcional: altera o transaction_id para evitar dedupe por backend
      payload.transaction_id = payload.transaction_id + '-test-' + Date.now();
      console.log('üîß Deduplica√ß√£o desativada temporariamente. Novo transaction_id:', payload.transaction_id);
    }

    // Chaves de deduplica√ß√£o (Session Storage)
    var txnId = payload.transaction_id;
    var ss = window.sessionStorage;
    var gaKey = 'ga4_p_' + txnId; // Encurtei a chave
    
    // Verifica se j√° enviou nesta sess√£o (desativado se noDedupe)
    var gaAlready = noDedupe ? false : !!(ss && ss.getItem(gaKey) === '1');

    var attempts = 0;
    var sent = false;

    function sendPurchase() {
      if (sent) return;
      attempts++;

      // Verifica se o GTAG existe
      if (typeof gtag === 'function') {
        
        // Envio para o GA4
        if (!gaAlready) {
          try {
            gtag('event', 'purchase', payload);
            sent = true;
            console.log('‚úÖ GA4 Purchase enviado:', payload);
            
            // Marca como enviado para n√£o repetir no F5 (somente se dedupe ativo)
            if (!noDedupe && ss) ss.setItem(gaKey, '1');
            
          } catch(e) {
            console.error('‚ùå Erro no disparo GA4:', e);
          }
        } else {
          console.log('‚ÑπÔ∏è Compra j√° registrada anteriormente (Deduplica√ß√£o ativa).');
          sent = true; // Marca como resolvido para parar de tentar
        }

        // --- INTEGRA√á√ÉO GOOGLE ADS (Opcional se voc√™ j√° importa do GA4) ---
        // Se voc√™ j√° vinculou GA4 e Ads e importou a convers√£o "purchase", 
        // este trecho abaixo pode duplicar seus dados. Use com cautela.
        var awId = '{{ aw_id|default("") }}';
        var awLabel = '{{ aw_label|default("") }}';
        
        if (awId && awLabel && (noDedupe || !ss.getItem('ads_' + txnId))) {
            gtag('event', 'conversion', {
                'send_to': awId + '/' + awLabel,
                'value': finalValue,
                'currency': 'BRL',
                'transaction_id': txnId
            });
            if (!noDedupe && ss) ss.setItem('ads_' + txnId, '1');
        }
        // ----------------------------------------------------------------

      } else {
        // Retry logic: Se o gtag ainda n√£o carregou, tenta novamente
        if (attempts <= 10) {
          console.warn('‚è≥ gtag n√£o encontrado, tentando novamente (' + attempts + '/10)...');
          setTimeout(sendPurchase, 500);
        } else {
          console.error('‚ùå Falha cr√≠tica: Biblioteca gtag.js n√£o carregou na p√°gina.');
        }
      }
    }

    // Inicia o processo
    window.addEventListener('load', function(){
      // Pequeno delay para garantir que outras libs carregaram
      setTimeout(sendPurchase, 500);
    });
  })();
</script>
{% endblock %}
