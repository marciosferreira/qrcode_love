{% extends "base.html" %}
{% block content %}
<div class="glass-card">
  <h2>Pagamento confirmado</h2>
  <p style="margin-bottom:1rem; color: var(--text-muted);">
    Obrigado! Seu pagamento foi processado.
  </p>
  <p style="margin-bottom:1rem;">Você pode continuar pelo botão abaixo.</p>
  <a href="{{ redirect_url }}" class="btn btn-primary">Ir agora</a>
</div>
{% endblock %}

{% block scripts %}
<script async src="https://www.googletagmanager.com/gtag/js?id={{ GA_MEASUREMENT_ID }}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);} 
  gtag('js', new Date());
  // Ativa debug_mode quando a URL tiver ?debug=1
  var params = new URLSearchParams(window.location.search);
  var debug = params.has('debug') || params.has('_dbg') || params.has('debug_mode');
  gtag('config', '{{ GA_MEASUREMENT_ID }}', { 'debug_mode': debug });

  // Valor: começa pelo conv_value do servidor; se 0, tenta ?v= da URL
  var v = Number("{{ conv_value|default(0) }}");
  if (!v || v <= 0) {
    var vq = params.get('v');
    if (vq) { v = Number((vq || '').replace(',', '.')); }
  }

  // Envia purchase com detalhes do plano e transaction_id
  gtag('event', 'purchase', {
    value: (isFinite(v) && v > 0) ? v : 0,
    currency: 'BRL',
    transaction_id: '{{ transaction_id|default(page_url) }}',
    items: [{
      item_id: '{{ plan_code|default("unknown") }}',
      item_name: 'Plano {{ plan_code|default("unknown") }}',
      price: (isFinite(v) && v > 0) ? v : 0,
      quantity: 1
    }],
    debug_mode: debug
  });

  console.log('GA4 purchase enviado:', v, 'plano:', '{{ plan_code|default("unknown") }}');
</script>
{% endblock %}
