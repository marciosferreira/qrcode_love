{% extends "base.html" %}
{% block content %}
<div class="glass-card">
  <h2>Pagamento confirmado</h2>
  <p style="margin-bottom:1rem; color: var(--text-muted);">
    Obrigado! Seu pagamento foi processado.
  </p>
  <p style="margin-bottom:1rem;">Você pode continuar pelo botão abaixo.</p>
  <a href="{{ redirect_url }}" class="btn btn-primary">Ir agora</a>
</div>
{% endblock %}

{% block scripts %}
<!-- Redirecionamento automático removido por solicitação -->

{% if aw_id and aw_label %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ aw_id }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', '{{ aw_id }}');
    gtag('event', 'conversion', {
      'send_to': '{{ aw_id }}/{{ aw_label }}',
      'value': Number("{{ conv_value|default(0) }}"),
      'currency': 'BRL'
    });
  </script>
{% endif %}

{% if GA_MEASUREMENT_ID %}
  <script>
    (function(){
      // Se gtag não estiver carregado (por não haver AW ID), carrega gtag para GA4
      if (typeof gtag === 'undefined') {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);} 
        var s = document.createElement('script');
        s.async = true;
        s.src = 'https://www.googletagmanager.com/gtag/js?id={{ GA_MEASUREMENT_ID }}';
        document.head.appendChild(s);
        gtag('js', new Date());
      }
      // Habilita debug_mode no GA4 quando a URL tiver ?debug=1 (ou _dbg/debug_mode)
      var params = new URLSearchParams(window.location.search);
      var debug = params.has('debug') || params.has('_dbg') || params.has('debug_mode');
      gtag('config', '{{ GA_MEASUREMENT_ID }}', { 'debug_mode': debug });
      // Observação: o 'config' do GA4 dispara um page_view automaticamente

      // Envia um evento explícito de purchase para facilitar visualização no DebugView
      var v = Number("{{ conv_value|default(0) }}");
      if (!v || v <= 0) {
        var vq = params.get('v');
        if (vq) {
          v = Number((vq || '').replace(',', '.'));
        }
      }
      gtag('event', 'purchase', {
        value: (isFinite(v) && v > 0) ? v : 0,
        currency: 'BRL',
        debug_mode: debug
      });
    })();
  </script>
{% endif %}
{% endblock %}
