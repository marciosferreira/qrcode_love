{% extends "base.html" %}
{% block content %}
<div class="glass-card">
  <h2>Pagamento confirmado</h2>
  <p style="margin-bottom:1rem; color: var(--text-muted);">
    Obrigado! Seu pagamento foi processado.
  </p>
  <p style="margin-bottom:1rem;">Você pode continuar pelo botão abaixo.</p>
  <a href="{{ redirect_url }}" class="btn btn-primary">Ir agora</a>
</div>
{% endblock %}

{% block scripts %}
<script>
  (function(){
    var params = new URLSearchParams(location.search);
    var debug = params.has('debug') || params.has('_dbg') || params.has('debug_mode');
    // Valor: começa pelo conv_value do servidor; se 0, tenta ?v= da URL
    var v = Number("{{ conv_value|default(0, true) }}");
    if (!v || v <= 0) {
      var vq = params.get('v');
      if (vq) { v = Number((vq || '').replace(',', '.')); }
    }

    var payload = {
      value: (isFinite(v) && v > 0) ? v : 0,
      currency: 'BRL',
      transaction_id: '{{ transaction_id|default(page_url, true) }}',
      items: [{
        item_id: '{{ plan_code|default("unknown", true) }}',
        item_name: 'Plano {{ plan_code|default("unknown", true) }}',
        price: (isFinite(v) && v > 0) ? v : 0,
        quantity: 1
      }],
      debug_mode: debug
    };

    var sent = false;
    var attempts = 0;
    function sendPurchase(){
      if (sent) { return; }
      attempts++;
      if (typeof gtag === 'function') {
        try {
          var eventPayload = Object.assign({}, payload, {
            event_callback: function(){
              console.log('GA4 purchase callback confirmado');
            }
          });
          gtag('event', 'purchase', eventPayload);
          sent = true;
          console.log('GA4 purchase enviado (tentativa ' + attempts + '):', payload);
        } catch(e){
          console.warn('Falha ao enviar GA4 purchase:', e);
        }

        // Disparo de conversão do Google Ads (se IDs existirem)
        var awId = '{{ aw_id|default("") }}';
        var awLabel = '{{ aw_label|default("") }}';
        if (awId && awLabel) {
          gtag('event', 'conversion', {
            send_to: awId + '/' + awLabel,
            value: payload.value,
            currency: payload.currency,
            transaction_id: payload.transaction_id
          });
          console.log('Google Ads conversion enviada:', awId + '/' + awLabel, payload.value);
        } else {
          console.log('AW IDs não configurados; conversão Ads não enviada');
        }
      } else {
        if (attempts <= 5) {
          console.warn('gtag não disponível ainda; tentando novamente... (tentativa ' + attempts + ')');
          setTimeout(sendPurchase, 400);
        } else {
          console.error('Não foi possível enviar GA4 purchase: gtag indisponível após múltiplas tentativas');
        }
      }
    }

    // Aguarda o carregamento e aplica um pequeno atraso para garantir config
    window.addEventListener('load', function(){
      setTimeout(sendPurchase, 300);
      // Tentativa extra para casos de inicialização lenta
      setTimeout(function(){ if(!sent) sendPurchase(); }, 1200);
    });
  })();
</script>
{% endblock %}
