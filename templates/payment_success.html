{% extends "base.html" %}
{% block content %}
<div class="glass-card">
  <h2>Pagamento confirmado</h2>
  <p style="margin-bottom:1rem; color: var(--text-muted);">
    Obrigado! Seu pagamento foi processado.
  </p>
  <a href="{{ redirect_url }}" class="btn btn-primary">Ver página</a>
</div>
{% endblock %}

{% block scripts %}
  <script id="purchase-data" type="application/json">
    {{ {'event':'purchase','value': conv_value|default(0), 'currency':'BRL'}|tojson }}
  </script>
  <script>
    (function(){
      var el = document.getElementById('purchase-data');
      var payload = { event: 'purchase', value: 0, currency: 'BRL' };
      try {
        var parsed = JSON.parse((el && el.textContent) || '{}');
        if (parsed && typeof parsed === 'object') {
          payload = parsed;
          if (typeof payload.value === 'string') {
            payload.value = parseFloat(payload.value) || 0;
          }
        }
      } catch (e) {}
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push(payload);
    })();
  </script>
{% if aw_id and aw_label %}
  <script async src="https://www.googletagmanager.com/gtag/js?id={{ aw_id }}"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date());
    gtag('config', '{{ aw_id }}');
    // Dispara a conversão do Google Ads com segurança
    setTimeout(function() {
      gtag('event', 'conversion', {
        send_to: '{{ aw_id }}/{{ aw_label }}',
        value: Number("{{ conv_value|default(0) }}"),
        currency: 'BRL'
      });
    }, 0);
  </script>
{% endif %}
{% endblock %}
